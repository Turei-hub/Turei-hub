name: PR Review and Report

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  review-and-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get the base branch
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Count files
          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          
          # Save to output
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT
      
      - name: Analyze changes
        id: analyze
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Get detailed statistics
          STATS=$(git diff --stat $BASE_SHA $HEAD_SHA)
          echo "Statistics:"
          echo "$STATS"
          
          # Get diff summary
          ADDITIONS=$(git diff --numstat $BASE_SHA $HEAD_SHA | awk '{sum+=$1} END {print sum}')
          DELETIONS=$(git diff --numstat $BASE_SHA $HEAD_SHA | awk '{sum+=$2} END {print sum}')
          
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          
          # Save stats
          echo "stats<<EOF" >> $GITHUB_OUTPUT
          echo "$STATS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Generate report
        id: report
        run: |
          # Create a report
          REPORT="## ðŸ“Š Pull Request Review Report
          
          **PR #${{ github.event.pull_request.number }}**: ${{ github.event.pull_request.title }}
          
          ### ðŸ“ Summary
          - **Author**: @${{ github.event.pull_request.user.login }}
          - **Branch**: \`${{ github.event.pull_request.head.ref }}\` â†’ \`${{ github.event.pull_request.base.ref }}\`
          - **Files Changed**: ${{ steps.changed-files.outputs.count }}
          - **Lines Added**: ${{ steps.analyze.outputs.additions }}
          - **Lines Deleted**: ${{ steps.analyze.outputs.deletions }}
          
          ### ðŸ“‚ Changed Files
          \`\`\`
          ${{ steps.changed-files.outputs.files }}
          \`\`\`
          
          ### ðŸ“ˆ Statistics
          \`\`\`
          ${{ steps.analyze.outputs.stats }}
          \`\`\`
          
          ### âœ… Review Status
          - Changed files have been analyzed
          - Statistics have been generated
          - Report has been created
          
          ---
          *This report was automatically generated by the PR Review workflow*"
          
          # Save report to file for posting
          echo "$REPORT" > /tmp/pr-report.md
          
          # Also save to output (need to handle multiline)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Post report as comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('/tmp/pr-report.md', 'utf8');
            
            // Check if we already posted a comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Pull Request Review Report')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
              console.log('Created new comment');
            }
      
      - name: Summary
        run: |
          echo "### âœ… PR Review Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Files analyzed: ${{ steps.changed-files.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lines added: ${{ steps.analyze.outputs.additions }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lines deleted: ${{ steps.analyze.outputs.deletions }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Report has been posted as a comment on the PR." >> $GITHUB_STEP_SUMMARY
